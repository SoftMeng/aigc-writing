# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

这是一个**中国文学小说/长篇文学作品 AI 辅助写作项目**，用于进行小说续写、章节创作和剧情管理。每个小说目录是独立的项目单元，根目录包含共享的写作技能和资源。

## Repository Structure

```
根目录/
├── .claude/
│   └── skills/                      # 共享写作技能
│       ├── writing-chinese-literary/  # 小说写作核心技能
│       │   ├── skill.md              # 技能定义（双阶段创作协议）
│       │   ├── 长篇范文.txt             # 风格参考范文
│       │   ├── 长篇范文_01.txt          # 风格参考范文01
│       │   ├── 长篇范文_02.txt          # 风格参考范文02
│       │   ├── 双阶段创作协议.md          # 完整创作流程
│       │   ├── QUALITY_CONTROL.md      # 质量门控机制
│       │   ├── ANTI_PATTERNS.md        # 反面教材避坑手册
│       │   ├── 重构常用技巧.md          # 章节重构技巧
│       │   └── scripts/
│       │       ├── README.md           # 脚本使用文档
│       │       ├── validate_chapter.py     # 单章质量审计
│       │       ├── analyze_recent_chapters.py  # 重复模式检测
│       │       └── extract_sample_text.py     # 范文提取工具
│       └── comfyui-image-generation/   # AI 插画生成技能
├── 小说项目A/                       # 独立小说项目（可以有多个）
│   ├── 正文/                         # 已完成的章节文件
│   ├── 原子库/                       # 人物、地点、设定等资料库
│   ├── 插图/                         # AI 生成的插画（可选）
│   ├── 章节简要梗概/                 # 章节梗概（可选，各项目自定义命名）
│   ├── 故事介绍.md                   # 故事背景介绍
│   └── CLAUDE.md                     # 项目级指南（可选）
├── 小说项目B/
├── 插画提示词生成流程.md             # 插画提示词设计指南
└── CLAUDE.md                         # 本文件
```

## 核心写作技能

### 技能加载
写作前必须先加载 `.claude/skills/writing-chinese-literary` 技能，该技能定义了完整的双阶段创作协议。

### 双阶段创作协议

**第一阶段：架构与结构设计**
1. **第零步 - 质量预检**：读取最近 10 章，分析场景/视角/结构分布，确认本章有实质性剧情进展，确认本章与前 3 章结构差异 > 40%。
2. **第一步 - 卷次识别**：判断章节所属卷次，查找对应梗概文件。如进入新卷，需提示用户。
3. **第二步 - 精准唤醒**：读取最近 3-5 章内容，分析剧情脉络、人物发展、风格变化，检查重复性（场景/视角/结构）。
4. **第三步 - 风格参考**：运行 `python .claude/skills/writing-chinese-literary/scripts/extract_sample_text.py -i .claude/skills/writing-chinese-literary/长篇范文.txt` 提取范文片段。
5. **第四步 - 扩容细纲**：设计详细的剧情结构框架（剧情要点、光影定调、感官预设、动作链条、场景多样性、视角规划、主线推进、差异化设计）。

**第二阶段：沉浸填充**
1. **避坑检查**：阅读 `ANTI_PATTERNS.md`
2. **正式写作**：按照扩容细纲进行沉浸式写作，输出到 `正文/` 目录（>3000字，对话 40-70%，至少2个场景，至少1次视角转换）
3. **质量验证**：自评剧情创新性、结构多样性、信息密度、连贯性、整体质量（任何项<6分需重写）
4. **脚本验证（强制闭环）**：运行 `python scripts/validate_chapter.py 正文/第XXX章.txt`，验证失败必须重新生成
5. **梗概补充**：如下一章无梗概，自动生成并保存到 `章节简要梗概/` 目录

### 章节文件命名规范

**按卷编写时**：`正文/第1卷_第001章_章节标题.txt`
**不按卷编写时**：`正文/第001章_章节标题.txt`

## 用户快捷操作

### 基础写作命令
- `下一章` - 在 `正文/` 文件夹创作下一章节（要求 >3000 字）
- `写第N章` - 创作指定章节
- `重构第N章` - 重构已有章节
- `生成章节梗概` - 在 `章节简要梗概/` 生成下一章梗概
- `生成原子记忆` - 在 `原子库/` 生成人物/设定资料
- `诊断质量` - 运行 `python .claude/skills/writing-chinese-literary/scripts/analyze_recent_chapters.py 正文/` 分析最近章节重复模式

### 插画相关
- `设计插画提示词` - 读取章节内容，按照 `插画提示词生成流程.md` 设计 AI 绘画提示词
- `生成图片` - 使用 comfyui-image-generation 技能生成图片（默认尺寸 768×1024，步数 9，输出到 `插图/` 文件夹）

## Python 工具

### 依赖安装
```bash
pip install jieba numpy
```

### 章节质量检查
```bash
# 验证单章质量（强制执行）
python .claude/skills/writing-chinese-literary/scripts/validate_chapter.py 正文/第XXX章.txt

# 分析最近10章（检测重复模式）
python .claude/skills/writing-chinese-literary/scripts/analyze_recent_chapters.py 正文/

# 分析最近N章
python .claude/skills/writing-chinese-literary/scripts/analyze_recent_chapters.py 正文/ N
```

### 范文提取工具
```bash
# 随机提取 20-30 行范文作为风格参考
python .claude/skills/writing-chinese-literary/scripts/extract_sample_text.py -i .claude/skills/writing-chinese-literary/长篇范文.txt

# 指定起始行和行数
python .claude/skills/writing-chinese-literary/scripts/extract_sample_text.py -i <文件> -s <起始行> -n <行数>
```

### 质量指标说明
- **字数**：≥ 3000字（充足）
- **对话比例**：≥ 15%（合理），40-70%（理想）
- **场景数量**：≥ 2个（多样）
- **词汇丰富度（TTR）**：> 0.5（高），0.3-0.5（一般），< 0.3（低）
- **句式律动度（Rhythm）**：> 18.0（目标），反映句子长度变化幅度
- **结构相似度**：与最近5章 < 60%（避免重复）

## 插画生成参数

- **尺寸**：768×1024（默认）
- **步数**：9（默认）
- **输出目录**：目标小说的 `插图/` 文件夹
- **文件格式**：`第N章_场景N_000N.jpg`

详细提示词设计流程见 `插画提示词生成流程.md`（七层结构：风格基调→构图设计→场景主体→人物细节→技法表现→色彩点缀→意境升华）

## 重要注意事项

### 防止章节写错目录
- **写作前确认工作目录**：确保当前在正确的小说项目根目录下（包含 `正文/`、`原子库/` 等子目录）
- **使用 Glob 工具定位文件**：写作前用 Glob 工具搜索 `正文/` 目录，确认路径正确
- **章节编号识别**：根据现有章节编号判断下一章编号，避免重复或跳号

### 避免模板化内容
- **禁止网文烂梗**：如"倒吸一口凉气"、"恐怖如斯"
- **禁止廉价抒情**：如"成了他唯一的救赎"、"注定是一场宿命"
- **禁止虚词堆砌**：如"无数的"、"极致的"、"绝美的"
- **禁止段落碎片化**：严禁将连贯动作拆分成大量单行段落，严禁滥用"......"作为分隔符

### 剧情连贯性要求
- 必须读取最近 3-5 章内容，确保剧情、人物、设定的一致性
- 提取关键信息（人物称谓、技能名称、地点设定）保持一致性
- 避免所有 `ANTI_PATTERNS.md` 中列出的反面模式

### 紧急停止机制
**触发条件**（满足任一即停止）：
- 连续 3 章结构相似度 > 80%
- 连续 5 章无实质性剧情进展
- 连续 10 章场景单一
- 用户反馈"重复""流水账""质量下降"
- 连续 20 章某条主线无进展

**处理流程**：
1. 立即停止生成新章节
2. 读取最近 30 章，识别重复模式
3. 重新规划：确定需要打破的模式和推进的主线
4. 强制变化：改变场景/视角/结构/主题，引入新冲突
5. 基于新规划创作，确保不再陷入旧模式

## 四层质量门控机制

### 第一层：生成前检查
- **剧情进展检查**：必须有具体事件/冲突/发现，不能只是"讨论X概念"
- **重复性检查**：避免连续5章讨论同一主题，避免与最近3章使用相同结构
- **连贯性检查**：时间线连续，角色状态一致，场景切换合理
- **主线推进检查**：外部冲突/内部成长/关系变化/悬念推进至少推进1条

### 第二层：内容要求
- **新事件**：至少1个新的具体事件（有明确时空背景）
- **角色发展**：至少1个角色有新的变化（内在心理+外在行为）
- **冲突升级**：必须有新的张力（明确对立双方）
- **环境变化**：场景/时间/条件有实质性变化

### 第三层：生成后验证
- 如果删除本章，读者会失去什么？
- 本章能否用"查找替换"从其他章节生成？
- 本章是否只做了"概念替换"而无新内容？
- 本章有至少3个独特信息点吗？
- **脚本验证（强制）**：`python scripts/validate_chapter.py 正文/第XXX章.txt`，验证失败必须重写

### 第四层：定期回顾
- **每10章**：小回顾（识别重复模式，评估质量趋势）
- **每20章**：大回顾（全面质量评估，剧情连贯性检查）
- **每50章**：里程碑回顾（总结成就，识别深层问题，战略性调整）

详见：`.claude/skills/writing-chinese-literary/QUALITY_CONTROL.md` 和 `.claude/skills/writing-chinese-literary/ANTI_PATTERNS.md`
